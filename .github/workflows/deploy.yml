name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14' # Specify your Node.js version

    - name: Install dependencies
      run: npm install

    - name: Build
      run: npm run build

    - name: Zip and Upload to S3
      run: |
        zip -r passionfruit-backend.zip . -x "*.git*"
        aws s3 cp passionfruit-backend.zip s3://${{secrets.S3_BUCKET}}/dist/passionfruit-backend.zip
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{secrets.AWS_REGION}} 
    - name: Deploy with CodeDeploy
      run: |
        aws deploy create-deployment \
          --application-name ${{secrets.AWS_APPLICATION_NAME}} \
          --deployment-config-name CodeDeployDefault.OneAtATime \
          --deployment-group-name ${{secrets.AWS_DEPLOYMENT_GROUP}} \
          --description "Passionfruit backend" \
          --s3-location bucket=${{secrets.S3_BUCKET}},key=dist/passionfruit-backend.zip,bundleType=zip
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'your-aws-region'
